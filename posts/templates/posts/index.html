{% extends 'base.html' %}
{% block stylesheet %}
<style>
  .count-badge {
    position: absolute;
    right: 1rem;
    border: 1px;
    color: #3498DB;
    border-color: #3498DB;
    background-color: #fff;
  }

  .list-group-item {
    padding: 0.4rem 0.8rem;
    font-size: 0.8rem;
    background-color: #f2f2f2;
    border-color: #f2f2f2;
  }

  .list-group-item:hover {
    color: #1a1a1a;
    background-color: #fff;
    border-color: #fff;
  }

  .list-group-item.active {
    color: #1a1a1a;
    background-color: #c4c9ce;
    border-color: #c4c9ce;
  }

  .post {
    padding: 2rem;
  }

  .post-time {
    font-size: 0.9em;
    color: #95a5a6;
  }

  .post-text {
    padding-top: 0.8rem;
    padding-bottom: 1rem;
  }

  .filter {
    padding-top: 2rem;
  }

  .filter-title {
    font-size: 1.1rem;
    padding-bottom: 0.5rem;
  }

  @media (max-width: 768px) {
    .post {
      padding-left: 1rem;
      padding-right: 1rem;
    }

    .filter-title {
      display: none;
    }

    .list-group {
      flex-direction: row;
      -webkit-flex-wrap: wrap;
      flex-wrap: wrap;
    }

    .list-group-item:first-child {
      border-top-left-radius: 0.5rem;
      border-top-right-radius: 0.5rem;
    }

    .list-group-item:last-child {
      border-bottom-right-radius: 0.5rem;
      border-bottom-left-radius: 0.5rem;
      margin-bottom: auto;
    }

    .list-group-item {
      border-radius: 0.5rem;
      padding: 0.15rem 0.5rem;
      margin: 0.3rem;
      font-size: 0.7rem;
      color: #fff;
      background-color: #2C3E50;
      border-color: #2C3E50;
    }

    .list-group-item:hover {
      color: #fff;
      background-color: #1e2b37;
      border-color: #1a252f;
    }

    .list-group-item.active {
      background-color: #3498DB;
      border-color: #3498DB;
    }

    .list-group-item > .badge {
      display: none;
    }

    .list-group-item-action {
      width: auto;
    }
  }

  @media (max-width: 600px) {
    .post {
      padding-left: 0;
      padding-right: 0;
    }
  }
</style>
{% endblock %}

{% block title %}Posts{% endblock %}

{% block content %}
  <div class="container">
    <div class="row">

      <div class="col-md-3 sidebar">
        <div class="filter sticky-top">
          <div class="filter-title">Filter by Tag</div>
          <ul class="list-group">
            {% for tag in tag_list %}
              <a class="tag list-group-item list-group-item-action" id="{{tag.name}}" href="{% url 'posts:index' tag.name %}">
                {{ tag }}<span class="badge badge-info badge-pill count-badge">{{ tag.post_set.all.count }}</span>
              </a>
            {% endfor %}
          </ul><br>
        </div>
      </div>


      <div class="col-md-9 posts">
          {% if post_list %}

            {% for post in post_list %}
            <div class="post">
              <h4>{{ post.title }}</h4>
              <div class="post-time">{{ post.pub_time }}</div>
              <div class="post-text">{{ post.text|striptags|safe|truncatechars:200 }}</div>

              <a class="btn btn-outline-info btn-sm" href="{% url 'posts:detail' post.id %}" role="button">Read more</a>
            </div>
            {% endfor %}
            <div id="newItems"></div>

          {% else %}
            <p>No posts yet.</p>
          {% endif %}
      </div>

    </div>

  </div>

{% endblock %}

{% block javascript %}
<script>

$(document).ready(function() {
  $(window).on('scroll', loadOnScroll);

  var tag = "{{ tag_chosen }}";
  if (tag != null) {
    var tag_name = "{{ tag_chosen.name }}"
    $('.tag[id=' + tag_name + ']').addClass('active');
  }
});

// Scroll globals
var pageNum = 1; // The latest page loaded
var hasNextPage = true; // Indicates whether to expect another page after this one

// loadOnScroll handler
var loadOnScroll = function() {
   // If the current scroll position is past out cutoff point...
    if ($(window).scrollTop() > $(window).height() * 0.6) {
        // temporarily unhook the scroll event watcher so we don't call a bunch of times in a row
        $(window).off('scroll', loadOnScroll);
        // execute the load function below that will visit the JSON feed and stuff data into the HTML
        loadItems();
    }
};

var loadItems = function() {
    // If the next page doesn't exist, just quit now
    if (hasNextPage === false) {
        return false
    }
    // Update the page number
    pageNum = pageNum + 1;
    // Configure the url we're about to hit
    $.ajax({
        url: '',
        data: {page_number: pageNum},
        dataType: 'json',
        success: function(data) {
            // Update global next page variable
            hasNextPage = true;//.hasNext;
            // Loop through all items
            for (var i = 0; i < data.length; i++) {
              var post = data[i]

                $("#newItems").before(
                  '<div class="post">' +
                  '<h4>' + post['fields']['title'] + '</h4>' +
                  '<div class="post-time">' + post['fields']['pub_time'] + '</div>' +
                  '<div class="post-text">' + post['fields']['text'].substr(0, 200) + '</div>' +
                  '<a class="btn btn-outline-info btn-sm" href="' + post['pk'] + '/" role="button">Read more</a>' +
                  '</div>'

                );
            }
        },
        error: function(data) {
            // When I get a 400 back, fail safely
            hasNextPage = false
        },
        complete: function(data, textStatus){
            // Turn the scroll monitor back on
            $(window).on('scroll', loadOnScroll);
        }
    });
};
</script>
{% endblock %}
